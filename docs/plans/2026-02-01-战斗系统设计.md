# 战斗系统设计

> 创建日期: 2026-02-01

## 概述

完善单人战斗逻辑，为后续多人模式打基础。战斗引擎放在 shared 包，客户端和服务端共用。

---

## 1. 速度系统

### 1.1 速度属性

Equipment 接口新增 `speed` 字段：

```typescript
interface Equipment {
  // ...existing fields
  speed?: number;  // 基础速度 (0-3)
}
```

### 1.2 五行速度修正

```typescript
const WUXING_SPEED_MODIFIER: Record<Wuxing, number> = {
  [Wuxing.FIRE]: 2,    // 火最快
  [Wuxing.METAL]: 1,   // 金次之
  [Wuxing.WOOD]: 0,    // 木中性
  [Wuxing.WATER]: -1,  // 水较慢
  [Wuxing.EARTH]: -2,  // 土最慢
};
```

### 1.3 速度计算

```typescript
最终速度 = 装备总速度 + 主五行修正
```

速度相同时，按五行优先级排序（火 > 金 > 木 > 水 > 土）。

---

## 2. 伤害计算

### 2.1 基础伤害

```typescript
基础伤害 = max(攻击力 - 防御力, 1)  // 最低保底 1 点
```

### 2.2 五行修正（乘法）

| 关系 | 基础倍率 | 等级差修正 |
|------|----------|------------|
| 相克 | 1.5x | 每级差 ±10% |
| 相生 | -0.5x | 每级差 ±5%（负数=治疗敌人） |
| 中性 | 1.0x | 每级差 ±5% |

### 2.3 最终伤害

```typescript
function calculateFinalDamage(attacker, defender): number {
  const base = max(attacker.attack - defender.defense, 1);
  const multiplier = calculateWuxingMultiplier(
    attacker.attackWuxing,
    defender.defenseWuxing
  );

  if (multiplier < 0) {
    // 相生：治疗敌人（返回负数）
    return floor(base * abs(multiplier)) * -1;
  }
  return floor(base * multiplier);
}
```

---

## 3. 战斗中装备更换

### 3.1 规则

- **PvE 战斗**：允许战斗中更换装备
- **PvP 最终战**：禁止更换装备

### 3.2 更换时机

玩家在自己行动前可选择：
1. 攻击 - 正常行动
2. 更换装备 - 消耗本回合行动
3. 脱下装备 - 变成空手状态

### 3.3 空手状态

```typescript
const UNARMED_ATTACK = {
  attack: 1,
  wuxing: null,  // 无五行属性
  speed: 0,
};
```

无五行攻击 = 纯物理，无克制/相生效果。

---

## 4. 技能触发系统

### 4.1 触发类型

| 类型 | 时机 |
|------|------|
| PASSIVE | 战斗初始化时应用到属性 |
| BATTLE_START | 战斗开始时 |
| ON_HIT | 攻击命中时 |
| ON_DEFEND | 被攻击时 |
| BATTLE_END | 战斗结束时 |

### 4.2 触发顺序

按速度排序后，即时触发：
1. 快的先行动
2. ON_HIT 在攻击时立即触发
3. ON_DEFEND 在被攻击时立即触发

---

## 5. 掉落系统

### 5.1 掉落数量

| 战斗类型 | 掉落数量 |
|----------|----------|
| 普通战斗 | 1-3 件 |
| 精英战斗 | 2-4 件 |
| 最终战斗 | 3-5 件 |

### 5.2 自动拾取

- 物品直接进入背包
- 背包满时自动炼化为法宝碎片
- 法宝碎片不占格子

### 5.3 战斗结束显示

- 显示获得物品列表
- 如有溢出显示"X 件物品炼化为碎片"
- 自动进入下一阶段

---

## 6. 战斗后流程

```
战斗胜利
    ↓
自动拾取掉落物（显示获得列表）
    ↓
同步阶段（多人：等待其他玩家；单人：跳过）
    ↓
节点三选一（随机生成 3 个节点选项）
    ↓
选择后进入下一轮
```

---

## 7. 战斗引擎架构

### 7.1 文件结构

```
packages/shared/src/logic/
├── BattleEngine.ts      # 战斗主循环
├── DamageCalculator.ts  # 伤害计算
├── SkillProcessor.ts    # 技能处理
└── SpeedResolver.ts     # 速度排序
```

### 7.2 引擎接口

```typescript
interface BattleConfig {
  allowEquipmentChange: boolean;
  isPvP: boolean;
}

interface BattleEvent {
  type: 'attack' | 'skill' | 'heal' | 'damage' | 'death' | 'equip_change';
  actorId: string;
  targetId?: string;
  value?: number;
  skillId?: string;
}

class BattleEngine {
  constructor(combatants: Combatant[], config: BattleConfig);
  run(): BattleEvent[];  // 执行完整战斗
  step(): BattleEvent | null;  // 单步执行
}
```

### 7.3 使用方式

**客户端：**
```typescript
const engine = new BattleEngine(combatants, {
  allowEquipmentChange: true,
  isPvP: false
});
const events = engine.run();
for (const event of events) {
  await this.playEventAnimation(event);
}
```

**服务端（未来）：**
```typescript
const engine = new BattleEngine(allPlayerCombatants, {
  allowEquipmentChange: false,
  isPvP: true
});
const events = engine.run();
this.broadcast('battleEvents', events);
```

---

## 8. 敌人系统

### 8.1 敌人模板

```typescript
interface EnemyTemplate {
  id: string;
  name: string;
  hp: number;
  attack: number;
  defense: number;
  speed: number;
  wuxing: Wuxing;
  wuxingLevel: number;
  skills: Skill[];
  dropTable: string;
}
```

### 8.2 敌人缩放

```typescript
const scaling = 1 + round * 0.15;  // 每轮 +15% 强度
```

### 8.3 西游主题敌人

| 类型 | 示例 |
|------|------|
| 普通怪 | 小妖、狼妖 |
| 精英怪 | 熊罴怪、蜘蛛精 |
| Boss | 牛魔王 |

---

## 9. 实现优先级

### 第一阶段 - 战斗核心
- [ ] Equipment 增加 speed 属性
- [ ] 实现 BattleEngine（速度排序、伤害计算、技能触发）
- [ ] 更新 BattleScene 使用新引擎

### 第二阶段 - 掉落与流程
- [ ] 多物品掉落 + 自动拾取
- [ ] 移除 RewardScene 三选一
- [ ] MapScene 显示三选一节点

### 第三阶段 - 战斗中换装
- [ ] BattleScene UI 支持换装操作
- [ ] BattleEngine 处理换装行动

### 第四阶段 - 多人准备
- [ ] 同步阶段占位实现
- [ ] BattleEngine 支持 PvP 配置

---

*文档版本：v1.0*
